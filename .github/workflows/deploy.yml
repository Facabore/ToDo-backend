name: Build & Deploy Backend (.NET) to VPS

on:
  push:
    branches:
      - master
    tags:
      - 'v*'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      IMAGE_NAME: ghcr.io/facabore/todo-backend

    steps:
        # 1?? Clona el repositorio
      - name: ?? Checkout repository
        uses: actions/checkout@v3

        # 2?? Configura Docker Buildx
      - name: ?? Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

        # 3?? Login a GitHub Container Registry (ghcr.io)
      - name: ?? Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

        # 4?? Define el tag de la imagen
      - name: ??? Set image tag
        id: meta
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
            echo "IMAGE_TAG=$VERSION" >> $GITHUB_OUTPUT
            echo "PUSH_LATEST=true" >> $GITHUB_OUTPUT
          else
            echo "IMAGE_TAG=latest" >> $GITHUB_OUTPUT
            echo "PUSH_LATEST=false" >> $GITHUB_OUTPUT
          fi


        # 5?? Build y Push de Docker
      - name: ?? Build & Push Docker image
        run: |
          docker build -t $IMAGE_NAME:${{ steps.meta.outputs.IMAGE_TAG }} -f ToDo-backend.Web.API/Dockerfile .

          if [[ "${{ steps.meta.outputs.PUSH_LATEST }}" == "true" ]]; then
            docker tag $IMAGE_NAME:${{ steps.meta.outputs.IMAGE_TAG }} $IMAGE_NAME:latest
          fi

          docker push $IMAGE_NAME:${{ steps.meta.outputs.IMAGE_TAG }}

          if [[ "${{ steps.meta.outputs.PUSH_LATEST }}" == "true" ]]; then
            docker push $IMAGE_NAME:latest
          fi


        # 6?? Cargar SSH
      - name: ?? Load SSH Key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # 7?? Test SSH antes de deploy
      - name: ?? Test SSH connectivity
        run: |
          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "echo '? SSH connection OK'"

        # 8?? Cargar archivo de configuración al VPS con Docker compose
      - name: ?? Deploy to VPS
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            cd ~/todo/backend-docker
            docker compose pull
            docker compose up -d
            docker restart ToDoApp.Api
          EOF

        